<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Admin NOVA BANK</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f7fc; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 5px; overflow: auto; }
        .error { color: red; }
        .success { color: green; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Diagnostic Admin NOVA BANK</h1>
        
        <div class="card">
            <h2>1. Test de connexion Supabase</h2>
            <button onclick="testConnexion()">Tester la connexion</button>
            <div id="testResult"></div>
        </div>

        <div class="card">
            <h2>2. Session utilisateur</h2>
            <button onclick="checkSession()">V√©rifier ma session</button>
            <div id="sessionResult"></div>
        </div>

        <div class="card">
            <h2>3. Charger tous les utilisateurs</h2>
            <button onclick="loadAllUsers()">Charger les utilisateurs</button>
            <div id="usersResult"></div>
        </div>

        <div class="card">
            <h2>4. Ajouter du solde</h2>
            <input type="text" id="userId" placeholder="ID utilisateur">
            <input type="number" id="montant" placeholder="Montant">
            <button onclick="addSolde()">Ajouter</button>
            <div id="addResult"></div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://oypihdbuovijjutuyqaj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGloZGJ1b3Zpamp1dHV5cWFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjEwNzIsImV4cCI6MjA4NjU5NzA3Mn0.j3ZXmUYoXtV6rKh7f4_QdrttxSDCTE1khIkV0dHGp4s';
        
        // Initialisation
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Fonction pour afficher les r√©sultats
        function displayResult(elementId, data, error) {
            const div = document.getElementById(elementId);
            if (error) {
                div.innerHTML = `<p class="error">‚ùå Erreur: ${JSON.stringify(error)}</p>`;
            } else {
                div.innerHTML = `<p class="success">‚úÖ Succ√®s!</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        }

        // 1. Test de connexion
        async function testConnexion() {
            try {
                const { data, error } = await _supabase.from('profiles').select('count', { count: 'exact', head: true });
                displayResult('testResult', { message: 'Connexion r√©ussie', count: data }, error);
            } catch (e) {
                displayResult('testResult', null, e);
            }
        }

        // 2. V√©rifier la session
        async function checkSession() {
            try {
                const { data: { user }, error } = await _supabase.auth.getUser();
                displayResult('sessionResult', { user: user }, error);
            } catch (e) {
                displayResult('sessionResult', null, e);
            }
        }

        // 3. Charger tous les utilisateurs
        async function loadAllUsers() {
            try {
                const { data, error } = await _supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                let html = '<h3>R√©sultat:</h3>';
                html += `<p>Nombre d'utilisateurs: ${data?.length || 0}</p>`;
                
                if (data && data.length > 0) {
                    html += '<table border="1" style="width:100%; border-collapse: collapse;">';
                    html += '<tr><th>ID</th><th>Nom</th><th>Email</th><th>Solde</th><th>Date</th></tr>';
                    data.forEach(user => {
                        html += `<tr>
                            <td>${user.id.substring(0,8)}...</td>
                            <td>${user.nom || '-'}</td>
                            <td>${user.email}</td>
                            <td>${user.solde || 0} ‚Ç¨</td>
                            <td>${new Date(user.created_at).toLocaleString()}</td>
                        </tr>`;
                    });
                    html += '</table>';
                } else {
                    html += '<p>Aucun utilisateur trouv√©</p>';
                }
                
                document.getElementById('usersResult').innerHTML = html;
                
            } catch (e) {
                document.getElementById('usersResult').innerHTML = `<p class="error">‚ùå Erreur: ${e.message}</p>`;
            }
        }

        // 4. Ajouter du solde
        async function addSolde() {
            const userId = document.getElementById('userId').value;
            const montant = parseFloat(document.getElementById('montant').value);
            
            if (!userId || !montant) {
                document.getElementById('addResult').innerHTML = '<p class="error">Veuillez remplir tous les champs</p>';
                return;
            }

            try {
                // R√©cup√©rer le solde actuel
                const { data: user, error: selectError } = await _supabase
                    .from('profiles')
                    .select('solde')
                    .eq('id', userId)
                    .single();

                if (selectError) throw selectError;

                const newBalance = (user.solde || 0) + montant;

                // Mettre √† jour
                const { error: updateError } = await _supabase
                    .from('profiles')
                    .update({ solde: newBalance })
                    .eq('id', userId);

                if (updateError) throw updateError;

                document.getElementById('addResult').innerHTML = `<p class="success">‚úÖ ${montant} ‚Ç¨ ajout√© avec succ√®s! Nouveau solde: ${newBalance} ‚Ç¨</p>`;
                
                // Recharger la liste
                loadAllUsers();
                
            } catch (e) {
                document.getElementById('addResult').innerHTML = `<p class="error">‚ùå Erreur: ${e.message}</p>`;
            }
        }

        // V√©rifier la session au chargement
        window.onload = async () => {
            await checkSession();
        };
    </script>
</body>
</html>