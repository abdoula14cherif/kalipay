<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA BANK - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f7fc; min-height: 100vh; }
        .header { background: #0b1a2f; padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 800; }
        .logo span { color: #ff5252; }
        .admin-info { display: flex; gap: 20px; align-items: center; }
        .logout-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 24px; border-radius: 40px; cursor: pointer; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        table { width: 100%; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        th { background: #f0f4ff; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .btn { padding: 8px 16px; border: none; border-radius: 30px; cursor: pointer; margin: 0 5px; }
        .btn-add { background: #e3f5eb; color: #2d9c5c; }
        .btn-remove { background: #ffeae8; color: #ff5252; }
        .alert { padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">NOVA<span>BANK</span></div>
        <div class="admin-info">
            <span id="adminEmail">chargement...</span>
            <button class="logout-btn" onclick="logout()">DÃ©connexion</button>
        </div>
    </header>

    <div class="container">
        <div class="alert" id="alertMessage"></div>
        <button onclick="loadUsers()" style="margin-bottom: 20px; padding: 10px 20px;">Actualiser</button>
        
        <div id="usersTable">
            <p style="text-align: center; padding: 40px;">Chargement...</p>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://oypihdbuovijjutuyqaj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGloZGJ1b3Zpamp1dHV5cWFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjEwNzIsImV4cCI6MjA4NjU5NzA3Mn0.j3ZXmUYoXtV6rKh7f4_QdrttxSDCTE1khIkV0dHGp4s';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUserId = null;

        async function checkAdmin() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user || user.email !== 'abdoula13cherif@gmail.com') {
                window.location.href = 'admin.html';
                return;
            }
            document.getElementById('adminEmail').textContent = user.email;
            loadUsers();
        }

        async function loadUsers() {
            try {
                document.getElementById('usersTable').innerHTML = '<p style="text-align: center; padding: 40px;">Chargement...</p>';
                
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    document.getElementById('usersTable').innerHTML = '<p style="text-align: center; padding: 40px;">Aucun utilisateur trouvÃ©</p>';
                    return;
                }

                let html = '<table><tr><th>Nom</th><th>Email</th><th>ID Carte</th><th>Solde</th><th>Date</th><th>Actions</th></tr>';
                
                data.forEach(user => {
                    html += `<tr>
                        <td>${user.nom || '-'} ${user.email === 'abdoula13cherif@gmail.com' ? 'ðŸ‘‘' : ''}</td>
                        <td>${user.email}</td>
                        <td>${user.numero_identite || '-'}</td>
                        <td>${user.solde || 0} â‚¬</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-add" onclick="openAddModal('${user.id}', '${user.nom}', ${user.solde})">+ Ajouter</button>
                            <button class="btn btn-remove" onclick="openRemoveModal('${user.id}', '${user.nom}', ${user.solde})">- Retirer</button>
                        </td>
                    </tr>`;
                });

                html += '</table>';
                document.getElementById('usersTable').innerHTML = html;

            } catch (error) {
                document.getElementById('usersTable').innerHTML = `<p style="color: red; text-align: center;">Erreur: ${error.message}</p>`;
            }
        }

        function openAddModal(id, name, balance) {
            currentUserId = id;
            const amount = prompt(`Ajouter du solde pour ${name || 'utilisateur'} (solde actuel: ${balance} â‚¬)`, "100");
            if (amount) confirmAdd(parseFloat(amount));
        }

        async function confirmAdd(amount) {
            if (!amount || amount <= 0) {
                alert('Montant invalide');
                return;
            }

            const { data, error } = await supabase
                .from('profiles')
                .select('solde')
                .eq('id', currentUserId)
                .single();

            if (error) {
                alert('Erreur: ' + error.message);
                return;
            }

            const newBalance = (data.solde || 0) + amount;
            
            const { error: updateError } = await supabase
                .from('profiles')
                .update({ solde: newBalance })
                .eq('id', currentUserId);

            if (updateError) {
                alert('Erreur: ' + updateError.message);
            } else {
                alert(`${amount} â‚¬ ajoutÃ© avec succÃ¨s !`);
                loadUsers();
            }
        }

        function openRemoveModal(id, name, balance) {
            currentUserId = id;
            const amount = prompt(`Retirer du solde pour ${name || 'utilisateur'} (solde actuel: ${balance} â‚¬)`, "50");
            if (amount) confirmRemove(parseFloat(amount));
        }

        async function confirmRemove(amount) {
            if (!amount || amount <= 0) {
                alert('Montant invalide');
                return;
            }

            const { data, error } = await supabase
                .from('profiles')
                .select('solde')
                .eq('id', currentUserId)
                .single();

            if (error) {
                alert('Erreur: ' + error.message);
                return;
            }

            const newBalance = (data.solde || 0) - amount;
            
            if (newBalance < 0) {
                alert('Solde insuffisant');
                return;
            }
            
            const { error: updateError } = await supabase
                .from('profiles')
                .update({ solde: newBalance })
                .eq('id', currentUserId);

            if (updateError) {
                alert('Erreur: ' + updateError.message);
            } else {
                alert(`${amount} â‚¬ retirÃ© avec succÃ¨s !`);
                loadUsers();
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'admin.html';
        }

        checkAdmin();
    </script>
</body>
</html>